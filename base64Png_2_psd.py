import base64
import numpy as np
import pytoshop

from io import BytesIO
from PIL import Image as plImage
from pytoshop.user.nested_layers import Group, Image
from pytoshop import enums, image_data
from pytoshop.user import nested_layers

if __name__ == '__main__':

	# base64 png to PIL image
	base64ImageData = "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"
	decodeBase64 = base64.b64decode(base64ImageData)
	bytesIO = BytesIO(decodeBase64)
	plImageData = plImage.open(bytesIO)

	# PIL image to pytoshop Image data
	convertImage = plImageData.convert("LA")
	img = np.array(convertImage)
	grayImage = np.max(img, axis = 2)

	width = img.shape[1]
	height = img.shape[0]
	alphaImage = np.zeros((height, width), dtype=np.int)
	for widthIndex in range(width-1):
		for heightIndex in range(height-1):
			alphaImage[heightIndex, widthIndex] = img[heightIndex, widthIndex][1]

	alphaImage 	= alphaImage.astype(np.uint8)
	grayImage 	= grayImage.astype(np.uint8)

	images = {
		enums.ColorChannel.red 		: grayImage, 
		enums.ColorChannel.green 	: grayImage, 
		enums.ColorChannel.blue 	: grayImage, 
		enums.ColorChannel.user_layer_mask : alphaImage
	}

	# set pytoshop Image to pytoshop Layers
	imageLayer = Image(
		name 	= 'Image',
		top 	= 0, 
		left 	= 0, 
		bottom	= images[enums.ColorChannel.user_layer_mask].shape[0], 
		right	= images[enums.ColorChannel.user_layer_mask].shape[1],
		color_mode = enums.ColorMode.rgb
	)
	for imageIndex, image in images.items():
		imageLayer.set_channel(imageIndex, image)

	imageLayers = [imageLayer]

	# pytoshop Layers to pytoshop Group
	layerGroups = [ Group(name="layerGroup", layers=imageLayers) ]

	# pytoshop Group to psd data
	psd = nested_layers.nested_layers_to_psd(layerGroups, 
		enums.ColorMode.rgb, 
		depth=enums.ColorDepth.depth8)	

	with open('output.psd', 'wb') as fd:
		psd.write(fd)
